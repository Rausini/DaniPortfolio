<!DOCTYPE html>
<html class="dark" lang="en"><head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Painel Administrativo</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
          darkMode: "class",
          theme: {
            extend: {
              colors: {
                primary: "#1717cf",
                "background-light": "#f6f6f8",
                "background-dark": "#111121",
              },
              fontFamily: {
                display: ["Space Grotesk"],
              },
              borderRadius: {
                DEFAULT: "0.25rem",
                lg: "0.5rem",
                xl: "0.75rem",
                full: "9999px",
              },
            },
          },
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
<div class="flex min-h-screen">
    <aside class="flex flex-col w-64 bg-background-light dark:bg-background-dark border-r border-gray-200/10 dark:border-gray-800/10">
        <div class="p-6">
            <h1 class="text-xl font-bold text-gray-900 dark:text-white">Painel de Controle</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Artista: Danielle Paes</p>
        </div>
        <nav class="flex-1 px-4">
            <a class="flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary" href="#">
                <span class="material-symbols-outlined">photo_library</span>
                <span class="font-medium">Gerenciamento de Imagens</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-primary/5 dark:hover:bg-primary/10" href="#">
                <span class="material-symbols-outlined">settings</span>
                <span class="font-medium">Configurações</span>
            </a>
        </nav>
        <div class="p-4 w-64">
            <button id="logoutBtn"
                    class="flex items-center justify-center gap-3 px-4 py-2 w-full bg-red-600 text-white rounded-lg font-medium opacity-100 group-hover:opacity-100 transition-opacity duration-300 delay-150 shadow-lg hover:bg-red-700">
                <span class="material-symbols-outlined">logout</span>
                <span>Sair</span>
            </button>
        </div>
    </aside>
    <main class="flex-1 p-8">
        <div class="flex justify-between items-start mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Galeria de Imagens</h2>
                <p class="text-gray-500 dark:text-gray-400">Visão geral das imagens atuais na galeria</p>
            </div>
            <button id="addImagesBtn" class="flex items-center justify-center gap-2 h-10 px-5 bg-primary text-white rounded-lg font-medium shadow-lg hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined">add_photo_alternate</span>
                <span>Adicionar Novas Imagens</span>
            </button>
        </div>

        <!-- Grid dinâmico -->
        <div id="galleryGrid" class="grid grid-cols-[repeat(auto-fill,minmax(200px,1fr))] gap-6"></div>

        <!-- Paginação (opcional) -->
        <div class="mt-6 flex items-center justify-between">
            <button id="prevPage" class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 disabled:opacity-40">Anterior</button>
            <div class="text-sm text-gray-500 dark:text-gray-400">
                Página <span id="pageNum" class="font-semibold">1</span>
            </div>
            <button id="nextPage" class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 disabled:opacity-40">Próxima</button>
        </div>

        <!-- Total -->
        <div class="mt-8 text-right text-gray-500 dark:text-gray-400">
            <p>Total de imagens: <span id="totalCount" class="font-bold text-gray-700 dark:text-gray-200">0</span></p>
        </div>

    </main>
</div>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
    // ====== SEUS VALORES ======
    const SUPABASE_URL = "https://teiqgonxzpanpjdzxteb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlaXFnb254enBhbnBqZHp4dGViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzY3MzgsImV4cCI6MjA3NTkxMjczOH0.h2fW3ZCPuEy0O4q1e-B0L8pvKpDnUNSR9uNeSzuWji0";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const BUCKET = 'gallery';

    // ====== GARANTE SESSÃO ======
    (async () => {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        window.location.replace("./"); // volta para login
        return;
      }
    })();

    // ====== LOGOUT ======
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("logoutBtn")?.addEventListener("click", async () => {
        await sb.auth.signOut();
        window.location.replace("./");
      });
    });

    // ====== UPLOAD ======
    document.addEventListener('DOMContentLoaded', () => {
      const addBtn = document.getElementById('addImagesBtn');
      if (!addBtn) return;

      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.multiple = true;
      fileInput.style.display = 'none';
      document.body.appendChild(fileInput);

      addBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', async () => {
        if (!fileInput.files?.length) return;
        try { await uploadImages(fileInput.files); }
        catch (err) { console.error(err); alert('Falha no upload. Veja o console.'); }
        finally { fileInput.value = ''; }
      });
    });

    async function uploadImages(fileList) {
      const files = Array.from(fileList);
      const maxMB = 20;
      for (const f of files) {
        if (!f.type.startsWith('image/')) { alert(`Arquivo inválido: ${f.name}`); return; }
        if (f.size > maxMB * 1024 * 1024) { alert(`"${f.name}" excede ${maxMB}MB.`); return; }
      }

      const { data: { user } } = await sb.auth.getUser();
      if (!user) { window.location.replace('./'); return; }

      const results = { ok: 0, fail: [] };

      for (const file of files) {
        const orig = file.name;
        const dot = orig.lastIndexOf('.');
        const base = dot > -1 ? orig.slice(0, dot) : orig;
        const ext  = (dot > -1 ? orig.slice(dot + 1) : 'jpg').toLowerCase();
        const safeBase = base.replace(/[^\w.-]+/g, '_').slice(0, 80);

        const makePath = () => {
          const uid = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2);
          return `uploads/${Date.now()}-${uid}-${safeBase}.${ext}`;
        };

        let path = makePath();

        // 1) upload com retry se 409
        let upErr, attempt = 0;
        do {
          const res = await sb.storage.from(BUCKET).upload(path, file, {
            cacheControl: '3600',
            upsert: false,
            contentType: file.type || 'image/*'
          });
          upErr = res.error;
          if (upErr && (upErr.statusCode === 409 || /exists|already/i.test(upErr.message || ''))) {
            path = makePath();
          } else break;
        } while (++attempt < 2);

        if (upErr) {
          console.error('Upload error', orig, upErr);
          results.fail.push({ name: orig, reason: upErr.message || String(upErr) });
          continue;
        }

        // 2) URL pública
        const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(path);
        const publicUrl = pub.publicUrl;

        // 3) insert no DB
        const { error: insErr } = await sb.from('images').insert({
          url: publicUrl,
          storage_path: path,
          title: orig,
          order: Math.floor(Date.now() / 1000),
          published: true
        });
        if (insErr) {
          console.error('DB insert error', orig, insErr);
          results.fail.push({ name: orig, reason: insErr.message || String(insErr) });
          await sb.storage.from(BUCKET).remove([path]).catch(() => {});
          continue;
        }

        results.ok += 1;
      }

      if (results.fail.length === 0) {
        alert('Uploads concluídos!');
      } else {
        const msg = [
          `Uploads concluídos com avisos.`,
          `Sucesso: ${results.ok}`,
          `Falhas: ${results.fail.length}`,
          '',
          ...results.fail.map(f => `- ${f.name}: ${f.reason}`)
        ].join('\n');
        alert(msg);
      }

      await loadGallery(); // refresca sem reload da página
    }

    // ====== EXCLUIR ======
    async function deleteImage(id) {
      const { data: rec, error: selErr } = await sb.from('images').select('storage_path').eq('id', id).single();
      if (selErr) { alert('Erro ao buscar registro.'); return; }

      if (rec?.storage_path) {
        await sb.storage.from(BUCKET).remove([rec.storage_path]).catch(() => {});
      }

      const { error: delErr } = await sb.from('images').delete().eq('id', id);
      if (delErr) { alert('Erro ao excluir do DB.'); return; }

      await loadGallery();
    }  <!-- <<< AQUI fecha deleteImage corretamente -->

    // ====== LISTAGEM (fora de deleteImage!) ======
    let PAGE = 1;
    const PAGE_SIZE = 18;
    let TOTAL = 0;

    function buildQuery() {
      const from = (PAGE - 1) * PAGE_SIZE;
      const to   = from + PAGE_SIZE - 1;

      return sb
        .schema('public')
        .from('images')
        .select('id,url,storage_path,title,order,published,created_at', { count: 'exact' })
        .order('order', { ascending: false })
        .order('created_at', { ascending: false })
        .range(from, to);
    }

    function skeletonCards(n = Math.min(PAGE_SIZE, 8)) {
      return Array.from({ length: n }).map(() =>
        `<div class="relative overflow-hidden rounded-lg border border-white/10 bg-white/5 animate-pulse aspect-square"></div>`
      ).join('');
    }

    function cardTemplate(img) {
      const safeTitle = img.title || 'Sem título';
      const badge = img.published
        ? '<span class="text-[10px] px-2 py-1 rounded bg-green-600/80 text-white">Publicado</span>'
        : '<span class="text-[10px] px-2 py-1 rounded bg-yellow-600/80 text-white">Rascunho</span>';

      return `
        <div class="group relative overflow-hidden rounded-lg border border-white/10 bg-white/5">
          <img src="${img.url}" alt="${safeTitle}" class="w-full h-full aspect-square object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy"/>
          <div class="absolute inset-x-0 top-0 p-2 flex items-center justify-between bg-gradient-to-b from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition">
            <span class="text-xs font-medium text-white truncate">${safeTitle}</span>
            ${badge}
          </div>
          <div class="absolute inset-x-0 bottom-0 p-2 flex items-center gap-2 justify-end bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition">
            <button data-action="toggle-publish" data-id="${img.id}" class="px-2 py-1 rounded bg-white/90 text-black text-xs hover:bg-white">
              ${img.published ? 'Despublicar' : 'Publicar'}
            </button>
            <button data-action="delete" data-id="${img.id}" class="px-2 py-1 rounded bg-red-600 text-white text-xs hover:bg-red-700">
              Excluir
            </button>
          </div>
        </div>
      `;
    }

    async function loadGallery() {
      const grid = document.getElementById('galleryGrid');
      const totalEl = document.getElementById('totalCount');
      const pageNum = document.getElementById('pageNum');
      if (!grid) { console.error('grid não encontrado'); return; }

      grid.innerHTML = skeletonCards();

      const { data, count, error } = await buildQuery();
      console.log('[images] =>', { error, count, got: data?.length, first: data?.[0] });

      if (error) {
        grid.innerHTML = `<div class="text-sm text-red-500">Falha ao carregar imagens.</div>`;
        return;
      }

      TOTAL = count ?? 0;
      if (totalEl) totalEl.textContent = String(TOTAL);
      if (pageNum) pageNum.textContent = String(PAGE);

      if (!data || data.length === 0) {
        grid.innerHTML = `<div class="text-sm text-gray-500 dark:text-gray-400">Nenhuma imagem encontrada.</div>`;
        return;
      }

      grid.innerHTML = data.map(cardTemplate).join('');
    }

    // AÇÕES (delegação)
    document.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if (!action || !id) return;

      if (action === 'delete') {
        if (!confirm('Tem certeza que deseja excluir esta imagem?')) return;
        await deleteImage(id);
        return;
      }

      if (action === 'toggle-publish') {
        const { data: cur, error: e1 } = await sb.from('images').select('published').eq('id', id).single();
        if (e1) { alert('Erro ao ler status.'); return; }
        const { error: e2 } = await sb.from('images').update({ published: !cur.published }).eq('id', id);
        if (e2) { alert('Erro ao atualizar status.'); return; }
        await loadGallery();
      }
    });

    // Paginação
    document.getElementById('prevPage')?.addEventListener('click', () => {
      if (PAGE > 1) { PAGE -= 1; loadGallery(); }
    });
    document.getElementById('nextPage')?.addEventListener('click', () => {
      const maxPage = Math.max(1, Math.ceil(TOTAL / 18));
      if (PAGE < maxPage) { PAGE += 1; loadGallery(); }
    });

    // Realtime (opcional)
    (function setupRealtime() {
      try {
        sb
          .channel('images-realtime')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'images' }, () => loadGallery())
          .subscribe();
      } catch {}
    })();

    // Boot
    document.addEventListener('DOMContentLoaded', loadGallery);
</script>
</body>
</html>